---
layout: post
title: Analysis of the Tsuru Exploit
date: 2024-05-13 11:46:00
description: Learn how Tsuru was exploited, resulting in a loss of 137.78 ETH which is worth $410,000.
tags: access-control tsuru
categories: blockchain-hacks
thumbnail: assets/img/tsuru-exploit.png
related_posts: true
toc:
  sidebar: left
---

## TL;DR

On May 10, 2024, Tsuru was exploited on the Base chain due to a smart contract vulnerability, which resulted in a loss of 137.78 ETH, which was worth approximately $410,000.

## Introduction to Tsuru

Tsuru is the original character created by a supposed Japanese illustrator, Tsurushima Tatsumi.

## Vulnerability Assessment

The root cause of the exploit is a lack of regulated access control.

### Steps

**Step 1:**

We attempt to analyse [the attack transaction](https://app.blocksec.com/explorer/tx/base/0xe63a8df8759f41937432cd34c590d85af61b3343cf438796c6ed2c8f5b906f62) executed by [the exploiter](https://basescan.org/address/0x7a5eb99c993f4c075c222f9327abc7426cfae386).

**Step 2:**

The exploited [TSURUWrapper contract](https://basescan.org/address/0x75ac62ea5d058a7f88f0c3a5f8f73195277c93da#code) had a vulnerable [onERC1155Received function](https://basescan.org/address/0x75ac62ea5d058a7f88f0c3a5f8f73195277c93da#code#L1848) that lacked proper authentication and enough access control.

```solidity
function onERC1155Received(address, address from, uint256 id, uint256 amount, bytes calldata) external override nonReentrant returns (bytes4) {
  require(id == tokenID, "Token ID does not match");

  if (msg.sender == address(erc1155Contract)) {
    return this.onERC1155Received.selector;
  }

  _safeMint(from, amount * ERC1155_RATIO); // Adjust minting based on the ERC1155_RATIO
  return this.onERC1155Received.selector;
}
```

**Step 3:**

As long as the id or tokenID parameter in this function corresponds to the ID of the project, it would allow anyone to mint the TSURU token and later swap it for ETH in the Uniswap Liquidity pool.

**Step 4:**

This exploiter on the Base chain [swapped](https://basescan.org/tx/0xfe091a2d175f488bd366d3a84e9c37a622d789bf4539defacfc5f2a08169e2ca) the [stolen 167 million Tsuru](https://basescan.org/tx/0x1f51bdcc52a44e81360597aeb77050c5049df202692a7121e352fdf7bde6283d) for 137.78 ETH, which were worth approximately $410,000, and [then bridged](https://www.basescan.org/tx/0x1f51bdcc52a44e81360597aeb77050c5049df202692a7121e352fdf7bde6283d) it to [this address](https://etherscan.io/address/0x5E209c84E8632c011B7B5209dda3f7e50409C446) on the Ethereum Mainnet. This address on the Ethereum Mainnet also [received 40.95 ETH](https://etherscan.io/tx/0x1a02f2843c45bed3e3c126e0778346a4d30b4e958ebed31d2e463a9be6558e05) worth of assets from [an old incident](https://twitter.com/PerpyFinance/status/1787385427403395562) that traces back to the incident involving [Perpy Finance](https://twitter.com/MetaSleuth/status/1788966866511438268).

**Step 5:**

The project was hacked [roughly two hours](https://basescan.org/tx/0x0812740dc17439c08876ab94926404f4b13d0457d4f17ef355ba8ad02c18f8c0) after its deployment, and at the time of this writing, the [address of the exploiter on the Ethereum Mainnet](https://debank.com/profile/0x5e209c84e8632c011b7b5209dda3f7e50409c446) has a hold of 179.68 ETH, which is worth approximately $516,129.

## Aftermath

The [team acknowledged](https://twitter.com/TsuruBase/status/1788941543514223046) the occurrence of the exploit and has also shared a detailed post-mortem report regarding the incident.

## Solution

To address the vulnerabilities exploited in the Tsuru smart contract, a multi-faceted approach focused on strengthening security protocols, improving contract design, and enhancing monitoring systems is essential. Firstly, introducing rigorous access control measures in smart contracts is critical. For the Tsuru case, specifically ensuring that the `onERC1155Received` function includes authentication checks to verify not only the contract addresses interacting but also the roles of the interacting accounts would prevent unauthorized access. This could be implemented by incorporating a modifier that checks if the caller is from a list of addresses pre-approved by the contract owner or holds a specific role defined within the contract’s governance framework.

Additionally, enhancing the contract’s logic to handle unexpected inputs more safely is necessary. For instance, implementing checks that validate the state changes within the contract before and after executing critical functions could help. This ensures that even if an unauthorized party were to call a function, they would not be able to cause state changes that could lead to asset theft or other undesired outcomes.

Improving the testing and deployment procedures is another crucial step. Before deployment, the contract should undergo thorough testing, including both automated tests and manual peer reviews. Utilizing testnets to simulate real-world usage and attacks can help uncover vulnerabilities that might not be evident in isolated tests. Furthermore, engaging external auditors to conduct security audits and offering bug bounty programs can incentivize the discovery and resolution of security flaws before they can be exploited maliciously.

_This article was [originally published](https://medium.com/p/630816199ff4) by Pukar Acharya elsewhere._
